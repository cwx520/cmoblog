# DDNS及如何利用cloudflare实现服务器隐藏和突破80及443封锁

*所谓DDNS 即需要利用家中的动态公网IP 通过服务定时轮询修改域名指向而实现动态DNS 其前提是家中的IP为公网IP而非电信子路由分配的内网IP*

步骤：

1.打电话给电信,要求自己家的IP提升为公网IP, 电信拒绝就强硬要求

2.如果家中使用光猫拨号需要把光猫改成桥接，使用路由器拨号，除非光猫足够强大能够满足你后期端口转发等需求（这步可能需要改变家中的网络结构）

3.需要一个设备能去轮询DNS解析服务商实现IP地址变化时去调用服务商API修改域名指向（前提是需要一个域名）

> 为了后续结合cloudflare 我们使用cloudflare（https://dash.cloudflare.com/）来作为域名DNS服务商，当然也可以选择阿里云，域名我们这边选择阿里云购买的域名（为了高匿也可以使用别的域名服务商）。
DDNS服务 我们使用开源的DDNS-GO（https://github.com/jeessy2/ddns-go） 这个比较好，有成熟的DOCKER镜像 方便部署。

4.家里搞个服务器或者软路由 部署DDNS-GO 本文以DOCKER部署为例 也可自行部署服务 国内DOCKER镜像使用https://docker.m.daocloud.io 阿里源没有这个镜像，配置DDNSGO的时候记得输入密码，完事了多配几个二级域名方便以后使用。配置后cloudflare需要去DNS处修改一下规则，选择下是直连还是代理，后续更新会保持这个规则。

5.使用DOCKER部署该服务（方式自己看文档，没有服务器可以部署在软路由或者NAS上只要支持DOCKER即可）获取cloudflare 的 TOKEN（全局的不行，需要设定好权限的才可以），cloudflare导入域名，域名需要修改DNS服务器为cloudflare的服务器才可以，部署好DDNS-GO，DOCKER控制台输入TOKEN及自己需要代理的域名，自生IP（需要代理到的IP 就是你现在的公网IP）选择使用公共接口查询。

6.cloudflare 点击域名，点击规则，点击Origin Rules 设置服务端口转发将所有传入请求重写到自己的目标端口比如8088

7.路由器配置端口转发，将8088转发到自己的服务端口即可。

> 完成上述步骤后 ping域名会是一个国外的服务器。cloudflare会使用CDN技术使得国内用户也可以正常访问，此时你的域名未经备案，你的IP 80 443 8080任然被电信封锁 但是你的域名却可以正常访问 并且完美隐藏自身的公网IP了。

!> 本文仅供学习使用，切勿违法乱纪，否则一切后果自行承担。

>关于cloudflare国内加速

国内访问cloudflare默认会走美帝的通道，转一圈回来会导致国内访问速度缓慢，我们可以通过自定义CDN节点分配来解决这个问题，但是由于cloudflare免费版不支持自定义CDN节点，我们只能够采用自定义主机名来实现，但是这样会损失一部分隐匿性。所谓自定义主机名，即通过点击域名下的SSL/TLS目录最后一项为自定义主机名，但是需要你填写VISA卡才能够开通。它的意思是将任意一个指定要CLOUDFLARE CDN节点的域名，分配给你已经定义过的域名的 DNS解析，比如你在CLOUDFLARE给A.COM定义到了你的主机IP 1.51.22.11 然后你在别的运营商那里有个域名B.COM 指向了CLOUDFLARE的任意一个 CDN 节点，这时候通过配置自定义主机名，添加回退源A.COM，然后添加自定义主机名B.COM（需要你在别的运营商配置TXT 验证） ，用户访问B.COM即可也访问到1.51.22.11  无需其他规则配置。 然后我们通过别的运营商的DNS分配原理  比如 指定CDN.B.COM 指向CLOUDFLARE亚太节点记录类型为A值为1.0.0.5 ，配置国外的所有访问。 指定CDN.B.COM 指向CLOUDFLARE国内的快速节点 比如CNAME 值为speed.marisalnc.com，配置国内的所有访问。 最后配置B.COM 指向 CDN.B.COM。此时访问B.COM 即可做到分流，可以使用阿里云（需要缴费）或者腾讯云的DNSPOD。
另外给一个CLOUDFLARE公共优选地址https://www.baota.me/post-411.html。

总结下上面的操作，就是利用CLOUDFLARE能够给其他域名分配给自己配置域名的DNS的功能，使用外部服务商的DNS功能，指向CLOUDFLARE节点。使得访问其他域名时能够访问到CLOUDFLARE代理的域名的实际IP ，再利用其它服务商的DNS分流功能，实现CDN节点选择。通过选择对于国内较快的CLOUDFLARE节点，实现加速功能。但是也存在几个问题，第一我们需要在国内运营商暴露实际的域名失去了完全匿名的能力，（实际上我们需要的时A.COM而不是B.COM）且B.COM必须备案才可以正常使用443 80等端口，失去了一部分便利性。